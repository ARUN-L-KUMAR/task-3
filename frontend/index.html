<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decentralized Event Ticketing</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Use local copy of ethers.js -->
    <script src="js/lib/ethers.min.js" type="application/javascript"></script>
    <!-- Fallback to CDN if local copy fails -->
    <script>
        window.addEventListener('error', function(e) {
            if (e.target.src && e.target.src.includes('ethers.min.js')) {
                console.log('Local ethers.js failed to load, trying CDN...');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
                script.type = 'application/javascript';
                document.head.appendChild(script);
            }
        }, true);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- Debug info -->
    <script>
        console.log('Page loaded');
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded');
            // Safely check if ethers is loaded
            try {
                console.log('Ethers version:', ethers ? ethers.version : 'not loaded');
            } catch (e) {
                console.error('Error checking ethers:', e);
            }
            console.log('MetaMask available:', typeof window.ethereum !== 'undefined');
        });
    </script>
</head>
<body>
    <header>
        <h1>Decentralized Event Ticketing</h1>
        <div id="wallet-info">
            <button id="connect-wallet">Connect Wallet</button>
            <div id="account-info" class="hidden">
                <span id="account-address"></span>
                <span id="account-balance"></span>
            </div>
        </div>
    </header>

    <main>
        <div class="tabs">
            <button class="tab-btn active" data-tab="events">Events</button>
            <button class="tab-btn" data-tab="my-tickets">My Tickets</button>
            <button class="tab-btn" data-tab="organizer">Organizer</button>
            <button class="tab-btn" data-tab="validator">Validator</button>
        </div>

        <div id="events" class="tab-content active">
            <h2>Available Events</h2>
            <div id="events-list" class="card-container">
                <!-- Events will be loaded here -->
                <div class="loading">Loading events...</div>
            </div>
        </div>

        <div id="my-tickets" class="tab-content">
            <h2>My Tickets</h2>
            <div id="tickets-list" class="card-container">
                <!-- Tickets will be loaded here -->
                <div class="loading">Connect your wallet to view tickets</div>
            </div>
        </div>

        <div id="organizer" class="tab-content">
            <h2>Event Organizer Dashboard</h2>

            <div class="card">
                <h3>Create New Event</h3>
                <form id="create-event-form">
                    <div class="form-group">
                        <label for="event-name">Event Name</label>
                        <input type="text" id="event-name" required>
                    </div>
                    <div class="form-group">
                        <label for="event-description">Description</label>
                        <textarea id="event-description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="event-date">Date</label>
                        <input type="datetime-local" id="event-date" required>
                    </div>
                    <div class="form-group">
                        <label for="event-price">Ticket Price (ETH)</label>
                        <input type="number" id="event-price" step="0.001" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="max-tickets">Maximum Tickets</label>
                        <input type="number" id="max-tickets" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="max-resell-price">Maximum Resell Price (ETH)</label>
                        <input type="number" id="max-resell-price" step="0.001" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="transfer-locked">Lock Transfers</label>
                        <input type="checkbox" id="transfer-locked">
                    </div>
                    <button type="submit">Create Event</button>
                </form>
            </div>

            <div class="card">
                <h3>My Events</h3>
                <div id="organizer-events" class="card-container">
                    <!-- Organizer events will be loaded here -->
                    <div class="loading">Connect your wallet to view your events</div>
                </div>
            </div>
        </div>

        <div id="validator" class="tab-content">
            <h2>Ticket Validator</h2>

            <div class="card">
                <h3>Validate Ticket</h3>
                <div class="form-group">
                    <label for="ticket-id">Ticket ID</label>
                    <input type="number" id="ticket-id" min="0">
                </div>
                <div class="form-group">
                    <label for="ticket-owner">Ticket Owner Address</label>
                    <input type="text" id="ticket-owner">
                </div>
                <button id="validate-ticket">Validate Ticket</button>
                <div id="validation-result" class="hidden"></div>
            </div>

            <div class="card">
                <h3>Scan QR Code</h3>
                <div id="qr-scanner">
                    <button id="start-scan">Start Scanner</button>
                    <video id="qr-video" class="hidden"></video>
                </div>
                <div id="scan-result" class="hidden"></div>
            </div>
        </div>
    </main>

    <!-- Modal for event details and ticket purchase -->
    <div id="event-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modal-event-name"></h2>
            <p id="modal-event-description"></p>
            <div id="modal-event-details">
                <p><strong>Date:</strong> <span id="modal-event-date"></span></p>
                <p><strong>Price:</strong> <span id="modal-event-price"></span> ETH</p>
                <p><strong>Available Tickets:</strong> <span id="modal-event-available"></span></p>
            </div>
            <button id="buy-ticket">Buy Ticket</button>
            <div id="purchase-status" class="hidden"></div>
        </div>
    </div>

    <!-- Modal for ticket details -->
    <div id="ticket-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Ticket Details</h2>
            <div id="ticket-qr"></div>
            <div id="modal-ticket-details">
                <p><strong>Event:</strong> <span id="modal-ticket-event"></span></p>
                <p><strong>Ticket ID:</strong> <span id="modal-ticket-id"></span></p>
                <p><strong>Status:</strong> <span id="modal-ticket-status"></span></p>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Decentralized Event Ticketing DApp</p>
    </footer>

    <script src="js/app.js"></script>
</body>
</html>
